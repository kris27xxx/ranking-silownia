<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASGARD GYM ‚Äî Ranking</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070a0f;
      --bg1:#0b1220;
      --card:#0c1528cc;
      --stroke:#1c2a44;
      --text:#eaf0ff;
      --muted:#a8b6d8;
      --gold:#d7b46a;
      --gold2:#ffd98a;
      --red:#ff6b6b;
      --green:#51cf66;
      --blue:#4dabf7;
      --shadow: 0 30px 80px rgba(0,0,0,.55);
      --radius: 20px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 450px at 20% 10%, rgba(215,180,106,.18), transparent 55%),
        radial-gradient(800px 380px at 80% 5%, rgba(120,160,255,.14), transparent 60%),
        radial-gradient(900px 500px at 50% 100%, rgba(0,0,0,.55), transparent 60%),
        linear-gradient(180deg, var(--bg0), #05070c);
      padding: 32px 16px 56px;
      animation: bgPulse 20s ease infinite;
    }

    @keyframes bgPulse {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .wrap{ 
      max-width: 1060px; 
      margin: 0 auto; 
      animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header{
      display:flex; align-items:center; gap:18px;
      margin: 4px 0 22px;
      animation: slideDown 0.8s ease;
      position: relative;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo{
      width:100px; 
      height:100px; 
      border-radius:16px;
      display:grid; 
      place-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      transition: transform 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.05) rotate(2deg);
    }

    .logo::after{
      content:"";
      position:absolute; inset:-60%;
      background: radial-gradient(circle at 30% 30%, rgba(215,180,106,.45), transparent 45%),
                  radial-gradient(circle at 70% 70%, rgba(215,180,106,.22), transparent 50%);
      transform: rotate(18deg);
      animation: logoShine 4s ease infinite;
    }

    @keyframes logoShine {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      position: relative;
      z-index: 2;
      border-radius: 12px;
    }

    .brand h1{
      margin:0;
      font-size: 44px;
      line-height: 1.02;
      letter-spacing: .04em;
      font-weight: 800;
      flex: 1;
    }
    .brand .sub{
      margin-top:6px;
      color: var(--muted);
      font-size: 16px;
    }

    .adminBtn {
      padding: 10px 20px;
      background: rgba(215,180,106,.15);
      border: 1px solid rgba(215,180,106,.3);
      border-radius: 12px;
      color: var(--gold2);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .adminBtn:hover {
      background: rgba(215,180,106,.25);
      transform: translateY(-2px);
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    .modal.show { display: flex; }

    .modalContent {
      background: linear-gradient(180deg, rgba(12,21,40,.98), rgba(9,16,32,.95));
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 20px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,.7);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modalContent h2 {
      margin: 0 0 24px;
      color: var(--gold2);
      font-size: 28px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.1);
      background: rgba(0,0,0,.3);
      color: var(--text);
      font-size: 16px;
      margin-bottom: 16px;
      outline: none;
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(215,180,106,.5);
      box-shadow: 0 0 0 4px rgba(215,180,106,.1);
    }

    button {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btnPrimary {
      background: linear-gradient(135deg, var(--gold), var(--gold2));
      color: #000;
    }
    .btnPrimary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(215,180,106,.4);
    }

    .btnSecondary {
      background: rgba(255,255,255,.05);
      color: var(--text);
      margin-top: 8px;
    }
    .btnSecondary:hover {
      background: rgba(255,255,255,.1);
    }

    .btnDanger {
      background: var(--red);
      color: #fff;
      padding: 8px 12px;
      width: auto;
      font-size: 14px;
    }

    .btnInfo {
      background: var(--blue);
      color: #fff;
      padding: 8px 12px;
      width: auto;
      font-size: 14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(12,21,40,.92), rgba(9,16,32,.88));
      border: 1px solid rgba(255,255,255,.07);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: cardSlideUp 0.9s ease;
      margin-bottom: 20px;
    }

    @keyframes cardSlideUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cardTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 18px 22px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: linear-gradient(90deg, rgba(215,180,106,.09), transparent 60%);
    }
    .cardTop .title{
      font-size: 18px;
      color: var(--muted);
      font-weight: 600;
    }
    select{
      min-width: 360px;
      max-width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      font-weight: 600;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
      transition: all 0.3s ease;
      margin: 0;
    }
    select:focus{
      border-color: rgba(215,180,106,.45);
      box-shadow: 0 0 0 4px rgba(215,180,106,.10);
      transform: scale(1.02);
    }

    .tableWrap{ padding: 6px 8px 16px; }
    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.06);
    }
    thead th{
      text-align:left;
      font-size: 16px;
      color: var(--muted);
      padding: 16px 16px;
      background: rgba(0,0,0,.18);
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-weight: 700;
    }
    
    tbody tr {
      animation: rowFadeIn 0.5s ease forwards;
      opacity: 0;
    }

    @keyframes rowFadeIn {
      to { opacity: 1; }
    }

    tbody tr:nth-child(1) { animation-delay: 0.1s; }
    tbody tr:nth-child(2) { animation-delay: 0.15s; }
    tbody tr:nth-child(3) { animation-delay: 0.2s; }
    tbody tr:nth-child(4) { animation-delay: 0.25s; }
    tbody tr:nth-child(5) { animation-delay: 0.3s; }
    tbody tr:nth-child(6) { animation-delay: 0.35s; }
    tbody tr:nth-child(7) { animation-delay: 0.4s; }
    tbody tr:nth-child(8) { animation-delay: 0.45s; }
    tbody tr:nth-child(9) { animation-delay: 0.5s; }
    tbody tr:nth-child(10) { animation-delay: 0.55s; }

    tbody td{
      padding: 16px 16px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      font-size: 18px;
      transition: all 0.3s ease;
    }
    tbody tr:nth-child(odd) td{ background: rgba(0,0,0,.18); }

    /* MEGA WYR√ì≈ªNIENIE TOP 3 */
    tbody tr:nth-child(1) td {
      background: linear-gradient(90deg, rgba(255,215,0,.15), rgba(255,215,0,.05)) !important;
      border-left: 4px solid #ffd700;
      font-size: 20px;
      font-weight: 800;
    }

    tbody tr:nth-child(1) .place .num {
      font-size: 28px;
      color: #ffd700;
      text-shadow: 0 0 20px rgba(255,215,0,.6);
    }

    tbody tr:nth-child(1) .athlete {
      font-size: 24px;
      color: #ffd700;
      text-shadow: 0 2px 10px rgba(255,215,0,.3);
    }

    tbody tr:nth-child(1) .result span:first-child {
      font-size: 26px;
      color: #ffd700;
    }

    tbody tr:nth-child(2) td {
      background: linear-gradient(90deg, rgba(192,192,192,.15), rgba(192,192,192,.05)) !important;
      border-left: 4px solid #c0c0c0;
      font-size: 19px;
    }

    tbody tr:nth-child(2) .place .num {
      font-size: 24px;
      color: #c0c0c0;
      text-shadow: 0 0 15px rgba(192,192,192,.5);
    }

    tbody tr:nth-child(2) .athlete {
      font-size: 22px;
      color: #e0e0e0;
    }

    tbody tr:nth-child(3) td {
      background: linear-gradient(90deg, rgba(205,127,50,.15), rgba(205,127,50,.05)) !important;
      border-left: 4px solid #cd7f32;
      font-size: 19px;
    }

    tbody tr:nth-child(3) .place .num {
      font-size: 24px;
      color: #cd7f32;
      text-shadow: 0 0 15px rgba(205,127,50,.5);
    }

    tbody tr:nth-child(3) .athlete {
      font-size: 22px;
      color: #d4a574;
    }

    tbody tr:nth-child(1):hover td,
    tbody tr:nth-child(2):hover td,
    tbody tr:nth-child(3):hover td {
      transform: translateX(8px) scale(1.01);
      box-shadow: 0 8px 30px rgba(0,0,0,.4);
    }

    tbody tr:hover td{
      background: rgba(215,180,106,.07);
    }

    .colPlace{ width: 140px; }
    .colWeight{ width: 100px; }
    .colActions{ width: 120px; }
    
    .place{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing: .02em;
    }
    .place .num{
      min-width: 22px;
      color: var(--gold2);
      text-shadow: 0 2px 18px rgba(215,180,106,.18);
    }
    .medal{
      font-size: 20px;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.35));
      animation: medalBounce 2s ease infinite;
    }

    @keyframes medalBounce {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-3px); }
    }

    .athlete{
      font-weight: 700;
      font-size: 20px;
    }
    .result{
      display:flex; align-items:baseline; gap:10px;
      justify-content:flex-start;
      font-weight: 800;
      color: var(--gold2);
    }
    .result .unit{
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .02em;
    }

    .weight {
      color: var(--muted);
      font-size: 16px;
      font-weight: 600;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .btnEdit, .btnDelete {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
    }

    .btnEdit {
      background: rgba(81,207,102,.2);
      color: var(--green);
    }
    .btnEdit:hover {
      background: rgba(81,207,102,.3);
    }

    .btnDelete {
      background: rgba(255,107,107,.2);
      color: var(--red);
    }
    .btnDelete:hover {
      background: rgba(255,107,107,.3);
    }

    .status{
      padding: 10px 22px 18px;
      color: var(--muted);
      font-size: 14px;
      min-height: 22px;
    }
    .err{ color: #ffb4b4; }
    .ok{ color: #bde3c5; }

    .adminPanel {
      display: none;
    }
    .adminPanel.show {
      display: block;
    }

    .formGroup {
      margin-bottom: 16px;
    }
    .formGroup label {
      display: block;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .challengeList {
      padding: 20px;
    }

    .challengeItem {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: rgba(0,0,0,.2);
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,.05);
    }

    .challengeItem.active {
      border-color: rgba(215,180,106,.3);
      background: rgba(215,180,106,.05);
    }

    .challengeInfo {
      flex: 1;
    }

    .challengeInfo h4 {
      margin: 0 0 4px;
      color: var(--text);
      font-size: 18px;
    }

    .challengeInfo .period {
      color: var(--muted);
      font-size: 14px;
    }

    .challengeInfo .badge {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(215,180,106,.2);
      color: var(--gold2);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .checkbox-wrapper label {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    @media (max-width: 760px){
      .header{ align-items:flex-start; flex-wrap: wrap; }
      .brand h1{ font-size: 34px; }
      .cardTop{ flex-direction: column; align-items:flex-start; }
      select{ width:100%; min-width: unset; }
      .colPlace{ width: 110px; }
      .colWeight{ width: 80px; }
      tbody td, thead th{ padding: 14px 12px; }
      .athlete{ font-size: 18px; }
      .logo{ width: 85px; height: 85px; }
      .actions { flex-direction: column; }
      .challengeItem { flex-direction: column; align-items: flex-start; gap: 12px; }
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="header">
      <div class="logo" aria-label="Asgard Gym logo">
        <img src="asgard.png" alt="Asgard Gym">
      </div>
      <div class="brand">
        <h1>ASGARD GYM</h1>
        <div class="sub" id="headerSub">≈Åadowanie challengu‚Ä¶</div>
      </div>
      <button class="adminBtn" id="adminToggle">Panel Admina</button>
    </div>

    <div class="adminPanel" id="adminPanel">
      <!-- ZarzƒÖdzanie Challengami -->
      <div class="card">
        <div class="cardTop">
          <div class="title">üèÜ ZarzƒÖdzanie Challengami</div>
        </div>
        <div style="padding: 20px;">
          <h3 style="color: var(--gold2); margin-top: 0;">Dodaj nowy Challenge</h3>
          <form id="addChallengeForm">
            <div class="formGroup">
              <label>Nazwa challengu (np. "Wyciskanie le≈ºƒÖc")</label>
              <input type="text" id="challengeTitle" required>
            </div>
            <div class="formGroup">
              <label>Okres (np. "Stycze≈Ñ 2026")</label>
              <input type="text" id="challengePeriod" required>
            </div>
            <div class="checkbox-wrapper">
              <input type="checkbox" id="challengeActive">
              <label for="challengeActive">Ustaw jako aktualny challenge</label>
            </div>
            <button type="submit" class="btnPrimary">Utw√≥rz Challenge</button>
          </form>

          <hr style="border: 1px solid rgba(255,255,255,.1); margin: 32px 0;">

          <h3 style="color: var(--gold2); margin-bottom: 16px;">IstniejƒÖce Challengy</h3>
          <div id="challengesList"></div>
        </div>
      </div>

      <!-- ZarzƒÖdzanie Zawodnikami -->
      <div class="card">
        <div class="cardTop">
          <div class="title">üë§ ZarzƒÖdzanie Zawodnikami</div>
          <button class="adminBtn" id="logoutBtn" style="padding: 8px 16px; font-size: 14px;">Wyloguj</button>
        </div>
        <div style="padding: 20px;">
          <h3 style="color: var(--gold2); margin-top: 0;">Dodaj zawodnika</h3>
          <form id="addScoreForm">
            <div class="formGroup">
              <label>Challenge</label>
              <select id="adminChallengeSelect" required></select>
            </div>
            <div class="formGroup">
              <label>Pozycja (np. 1, 2, 3...)</label>
              <input type="number" id="adminPosition" min="1" required>
            </div>
            <div class="formGroup">
              <label>Imiƒô zawodnika</label>
              <input type="text" id="adminAthlete" required>
            </div>
            <div class="formGroup">
              <label>Waga (kg)</label>
              <input type="number" step="0.1" id="adminWeight">
            </div>
            <div class="formGroup">
              <label>Wynik</label>
              <input type="number" step="0.1" id="adminScore" required>
            </div>
            <div class="formGroup">
              <label>Jednostka</label>
              <select id="adminUnit" required>
                <option value="kg">kg</option>
                <option value="reps">reps</option>
                <option value="sec">sec</option>
                <option value="pkt">pkt</option>
              </select>
            </div>
            <button type="submit" class="btnPrimary">Dodaj do rankingu</button>
          </form>
        </div>
      </div>
    </div>

    <div id="publicView">
      <div class="card">
        <div class="cardTop">
          <div class="title">Wybierz challenge (aktualny + archiwum)</div>
          <select id="challengeSelect" aria-label="Wyb√≥r challengu"></select>
        </div>

        <div class="tableWrap">
          <table id="rankingTable" aria-label="Tabela wynik√≥w">
            <thead>
              <tr>
                <th class="colPlace">Miejsce</th>
                <th>Zawodnik</th>
                <th class="colWeight">Waga</th>
                <th>Wynik</th>
                <th class="colActions" id="actionsHeader" style="display:none;">Akcje</th>
              </tr>
            </thead>
            <tbody id="rankingBody"></tbody>
          </table>
        </div>

        <div class="status" id="status"></div>
      </div>
    </div>

  </div>

  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modalContent">
      <h2>üîí Panel Admina</h2>
      <form id="loginForm">
        <input type="password" id="passwordInput" placeholder="Wpisz has≈Ço..." required>
        <button type="submit" class="btnPrimary">Zaloguj</button>
        <button type="button" class="btnSecondary" id="cancelLogin">Anuluj</button>
      </form>
    </div>
  </div>

  <!-- Edit Score Modal -->
  <div class="modal" id="editModal">
    <div class="modalContent">
      <h2>Edytuj zawodnika</h2>
      <form id="editScoreForm">
        <input type="hidden" id="editScoreId">
        <div class="formGroup">
          <label>Pozycja</label>
          <input type="number" id="editPosition" min="1" required>
        </div>
        <div class="formGroup">
          <label>Imiƒô zawodnika</label>
          <input type="text" id="editAthlete" required>
        </div>
        <div class="formGroup">
          <label>Waga (kg)</label>
          <input type="number" step="0.1" id="editWeight">
        </div>
        <div class="formGroup">
          <label>Wynik</label>
          <input type="number" step="0.1" id="editScore" required>
        </div>
        <div class="formGroup">
          <label>Jednostka</label>
          <select id="editUnit" required>
            <option value="kg">kg</option>
            <option value="reps">reps</option>
            <option value="sec">sec</option>
            <option value="pkt">pkt</option>
          </select>
        </div>
        <button type="submit" class="btnPrimary">Zapisz zmiany</button>
        <button type="button" class="btnSecondary" id="cancelEdit">Anuluj</button>
      </form>
    </div>
  </div>

  <!-- Edit Challenge Modal -->
  <div class="modal" id="editChallengeModal">
    <div class="modalContent">
      <h2>Edytuj Challenge</h2>
      <form id="editChallengeForm">
        <input type="hidden" id="editChallengeId">
        <div class="formGroup">
          <label>Nazwa challengu</label>
          <input type="text" id="editChallengeTitle" required>
        </div>
        <div class="formGroup">
          <label>Okres</label>
          <input type="text" id="editChallengePeriod" required>
        </div>
        <div class="checkbox-wrapper">
          <input type="checkbox" id="editChallengeActive">
          <label for="editChallengeActive">Ustaw jako aktualny challenge</label>
        </div>
        <button type="submit" class="btnPrimary">Zapisz zmiany</button>
        <button type="button" class="btnSecondary" id="cancelEditChallenge">Anuluj</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = "https://bzjtdwsvnhukmcjdvyen.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6anRkd3N2bmh1a21jamR2eWVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzc5NDgsImV4cCI6MjA4MTY1Mzk0OH0.o-W4nvYWzvEfxzIX2qJyDEhD21ncMVNBycFzinw7foo";
    const ADMIN_PASSWORD = "asgard2025"; // ZMIE≈É TO!

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let isAdmin = sessionStorage.getItem('asgardAdmin') === 'true';
    let currentChallengeId = null;

    const selectEl = document.getElementById("challengeSelect");
    const adminSelectEl = document.getElementById("adminChallengeSelect");
    const tbodyEl = document.getElementById("rankingBody");
    const headerSubEl = document.getElementById("headerSub");
    const statusEl = document.getElementById("status");
    const adminPanel = document.getElementById("adminPanel");
    const publicView = document.getElementById("publicView");
    const loginModal = document.getElementById("loginModal");
    const editModal = document.getElementById("editModal");
    const editChallengeModal = document.getElementById("editChallengeModal");
    const actionsHeader = document.getElementById("actionsHeader");
    const challengesListEl = document.getElementById("challengesList");

    function medalFor(position){
      if (position === 1) return "ü•á";
      if (position === 2) return "ü•à";
      if (position === 3) return "ü•â";
      return "";
    }

    function setStatus(msg, kind=""){
      statusEl.className = "status " + (kind || "");
      statusEl.textContent = msg || "";
    }

    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    function updateAdminUI() {
      if (isAdmin) {
        adminPanel.classList.add('show');
        actionsHeader.style.display = '';
        loadChallengesList();
      } else {
        adminPanel.classList.remove('show');
        actionsHeader.style.display = 'none';
      }
    }

    async function loadChallenges(){
      setStatus("≈Åadowanie challengy‚Ä¶");

      const { data, error } = await supabaseClient
        .from("challenges")
        .select("id, title, period, is_active")
        .order("created_at", { ascending: false });

      if (error){
        setStatus("B≈ÇƒÖd pobierania challengy: " + error.message, "err");
        return [];
      }

      const sorted = [...(data || [])].sort((a,b) => (b.is_active?1:0) - (a.is_active?1:0));

      selectEl.innerHTML = "";
      adminSelectEl.innerHTML = "";
      
      for (const ch of sorted){
        const label = `${ch.title} ‚Äî ${ch.period}${ch.is_active ? " (AKTUALNY)" : ""}`;
        
        const opt1 = document.createElement("option");
        opt1.value = ch.id;
        opt1.textContent = label;
        selectEl.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = ch.id;
        opt2.textContent = label;
        adminSelectEl.appendChild(opt2);
      }

      const active = sorted.find(x => x.is_active) || sorted[0];
      if (active) {
        selectEl.value = String(active.id);
        adminSelectEl.value = String(active.id);
        currentChallengeId = active.id;
      }

      setStatus("");
      return sorted;
    }

    async function loadChallengesList() {
      const { data, error } = await supabaseClient
        .from("challenges")
        .select("id, title, period, is_active")
        .order("created_at", { ascending: false });

      if (error) {
        challengesListEl.innerHTML = '<p style="color: var(--red);">B≈ÇƒÖd ≈Çadowania challengy</p>';
        return;
      }

      if (!data || data.length === 0) {
        challengesListEl.innerHTML = '<p style="color: var(--muted);">Brak challengy</p>';
        return;
      }

      challengesListEl.innerHTML = data.map(ch => `
        <div class="challengeItem ${ch.is_active ? 'active' : ''}">
          <div class="challengeInfo">
            <h4>
              ${escapeHtml(ch.title)}
              ${ch.is_active ? '<span class="badge">AKTUALNY</span>' : ''}
            </h4>
            <div class="period">${escapeHtml(ch.period)}</div>
          </div>
          <div class="actions">
            <button class="btnEdit" onclick="editChallenge(${ch.id})">Edytuj</button>
            <button class="btnDelete" onclick="deleteChallenge(${ch.id})">Usu≈Ñ</button>
          </div>
        </div>
      `).join('');
    }

    async function loadScores(challengeId){
      if (!challengeId) return;
      currentChallengeId = challengeId;

      setStatus("≈Åadowanie wynik√≥w‚Ä¶");
      tbodyEl.innerHTML = "";

      const { data: scores, error } = await supabaseClient
        .from("scores")
        .select("id, position, athlete, score, unit, weight")
        .eq("challenge_id", Number(challengeId))
        .order("position", { ascending: true })
        .limit(50);

      if (error){
        setStatus("B≈ÇƒÖd pobierania wynik√≥w: " + error.message, "err");
        return;
      }

      const selectedText = selectEl.options[selectEl.selectedIndex]?.textContent || "";
      headerSubEl.innerHTML = escapeHtml(selectedText);

      if (!scores || scores.length === 0){
        setStatus("Brak wynik√≥w dla tego challengu.", "ok");
        return;
      }

      for (const row of scores){
        const pos = Number(row.position);
        const medal = medalFor(pos);
        const weightText = row.weight ? `${row.weight} kg` : "‚Äî";
        
        const tr = document.createElement("tr");
        tr.dataset.scoreId = row.id;
        
        let actionsHtml = '';
        if (isAdmin) {
          actionsHtml = `
            <td class="colActions">
              <div class="actions">
                <button class="btnEdit" onclick="editScore(${row.id})">Edytuj</button>
                <button class="btnDelete" onclick="deleteScore(${row.id})">Usu≈Ñ</button>
              </div>
            </td>
          `;
        }

        tr.innerHTML = `
          <td class="colPlace">
            <div class="place">
              <span class="num">${escapeHtml(pos)}</span>
              <span class="medal">${medal}</span>
            </div>
          </td>
          <td><span class="athlete">${escapeHtml(row.athlete)}</span></td>
          <td class="colWeight"><span class="weight">${escapeHtml(weightText)}</span></td>
          <td>
            <div class="result">
              <span>${escapeHtml(row.score)}</span>
              <span class="unit">${escapeHtml(row.unit || "")}</span>
            </div>
          </td>
          ${actionsHtml}
        `;
        tbodyEl.appendChild(tr);
      }

      setStatus("");
    }

    async function adjustPositions(challengeId, newPosition, excludeId = null) {
      const { data: scores, error } = await supabaseClient
        .from("scores")
        .select("id, position")
        .eq("challenge_id", Number(challengeId))
        .order("position", { ascending: true });

      if (error) return;

      const toUpdate = [];
      let currentPos = 1;

      for (const score of scores) {
        if (excludeId && score.id === excludeId) continue;
        
        if (currentPos === newPosition) {
          currentPos++;
        }
        
        if (score.position !== currentPos) {
          toUpdate.push({ id: score.id, position: currentPos });
        }
        currentPos++;
      }

      for (const update of toUpdate) {
        await supabaseClient
          .from("scores")
          .update({ position: update.position })
          .eq("id", update.id);
      }
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const password = document.getElementById('passwordInput').value;
      
      if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        sessionStorage.setItem('asgardAdmin', 'true');
        loginModal.classList.remove('show');
        updateAdminUI();
        loadScores(currentChallengeId);
        document.getElementById('passwordInput').value = '';
      } else {
        alert('Nieprawid≈Çowe has≈Ço!');
      }
    });

    document.getElementById('adminToggle').addEventListener('click', () => {
      if (isAdmin) {
        adminPanel.classList.toggle('show');
      } else {
        loginModal.classList.add('show');
      }
    });

    document.getElementById('cancelLogin').addEventListener('click', () => {
      loginModal.classList.remove('show');
      document.getElementById('passwordInput').value = '';
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      isAdmin = false;
      sessionStorage.removeItem('asgardAdmin');
      updateAdminUI();
      loadScores(currentChallengeId);
    });

    // Add challenge
    document.getElementById('addChallengeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const title = document.getElementById('challengeTitle').value;
      const period = document.getElementById('challengePeriod').value;
      const isActive = document.getElementById('challengeActive').checked;

      // Je≈õli ustawiamy jako aktywny, dezaktywuj inne
      if (isActive) {
        await supabaseClient
          .from("challenges")
          .update({ is_active: false })
          .neq('id', 0);
      }

      const { error } = await supabaseClient
        .from("challenges")
        .insert({ title, period, is_active: isActive });

      if (error) {
        alert('B≈ÇƒÖd dodawania challengu: ' + error.message);
      } else {
        alert('Challenge utworzony!');
        document.getElementById('addChallengeForm').reset();
        await loadChallenges();
        loadChallengesList();
      }
    });

    // Edit challenge
    window.editChallenge = async (id) => {
      const { data, error } = await supabaseClient
        .from("challenges")
        .select("*")
        .eq("id", id)
        .single();

      if (error) {
        alert('B≈ÇƒÖd ≈Çadowania danych');
        return;
      }

      document.getElementById('editChallengeId').value = data.id;
      document.getElementById('editChallengeTitle').value = data.title;
      document.getElementById('editChallengePeriod').value = data.period;
      document.getElementById('editChallengeActive').checked = data.is_active;

      editChallengeModal.classList.add('show');
    };

    document.getElementById('editChallengeForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = Number(document.getElementById('editChallengeId').value);
      const title = document.getElementById('editChallengeTitle').value;
      const period = document.getElementById('editChallengePeriod').value;
      const isActive = document.getElementById('editChallengeActive').checked;

      if (isActive) {
        await supabaseClient
          .from("challenges")
          .update({ is_active: false })
          .neq('id', id);
      }

      const { error } = await supabaseClient
        .from("challenges")
        .update({ title, period, is_active: isActive })
        .eq("id", id);

      if (error) {
        alert('B≈ÇƒÖd zapisywania: ' + error.message);
      } else {
        alert('Zapisano zmiany!');
        editChallengeModal.classList.remove('show');
        await loadChallenges();
        loadChallengesList();
        loadScores(currentChallengeId);
      }
    });

    document.getElementById('cancelEditChallenge').addEventListener('click', () => {
      editChallengeModal.classList.remove('show');
    });

    // Delete challenge
    window.deleteChallenge = async (id) => {
      if (!confirm('‚ö†Ô∏è Usuniƒôcie challengu skasuje te≈º wszystkie wyniki!\n\nNa pewno kontynuowaƒá?')) return;

      // Usu≈Ñ wyniki
      await supabaseClient
        .from("scores")
        .delete()
        .eq("challenge_id", id);

      // Usu≈Ñ challenge
      const { error } = await supabaseClient
        .from("challenges")
        .delete()
        .eq("id", id);

      if (error) {
        alert('B≈ÇƒÖd usuwania: ' + error.message);
      } else {
        alert('Challenge usuniƒôty!');
        await loadChallenges();
        loadChallengesList();
        
        if (currentChallengeId === id) {
          const chs = await loadChallenges();
          if (chs && chs.length > 0) {
            loadScores(chs[0].id);
          }
        }
      }
    };

    // Add score
    document.getElementById('addScoreForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const challengeId = Number(adminSelectEl.value);
      const position = Number(document.getElementById('adminPosition').value);
      const athlete = document.getElementById('adminAthlete').value;
      const weight = document.getElementById('adminWeight').value || null;
      const score = Number(document.getElementById('adminScore').value);
      const unit = document.getElementById('adminUnit').value;

      await adjustPositions(challengeId, position);

      const { error } = await supabaseClient
        .from("scores")
        .insert({
          challenge_id: challengeId,
          position,
          athlete,
          weight: weight ? Number(weight) : null,
          score,
          unit
        });

      if (error) {
        alert('B≈ÇƒÖd dodawania: ' + error.message);
      } else {
        alert('Zawodnik dodany!');
        document.getElementById('addScoreForm').reset();
        loadScores(currentChallengeId);
      }
    });

    // Edit score
    window.editScore = async (id) => {
      const { data, error } = await supabaseClient
        .from("scores")
        .select("*")
        .eq("id", id)
        .single();

      if (error) {
        alert('B≈ÇƒÖd ≈Çadowania danych');
        return;
      }

      document.getElementById('editScoreId').value = data.id;
      document.getElementById('editPosition').value = data.position;
      document.getElementById('editAthlete').value = data.athlete;
      document.getElementById('editWeight').value = data.weight || '';
      document.getElementById('editScore').value = data.score;
      document.getElementById('editUnit').value = data.unit;

      editModal.classList.add('show');
    };

    document.getElementById('editScoreForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = Number(document.getElementById('editScoreId').value);
      const newPosition = Number(document.getElementById('editPosition').value);
      const athlete = document.getElementById('editAthlete').value;
      const weight = document.getElementById('editWeight').value || null;
      const score = Number(document.getElementById('editScore').value);
      const unit = document.getElementById('editUnit').value;

      await adjustPositions(currentChallengeId, newPosition, id);

      const { error } = await supabaseClient
        .from("scores")
        .update({
          position: newPosition,
          athlete,
          weight: weight ? Number(weight) : null,
          score,
          unit
        })
        .eq("id", id);

      if (error) {
        alert('B≈ÇƒÖd zapisywania: ' + error.message);
      } else {
        alert('Zapisano zmiany!');
        editModal.classList.remove('show');
        loadScores(currentChallengeId);
      }
    });

    document.getElementById('cancelEdit').addEventListener('click', () => {
      editModal.classList.remove('show');
    });

    // Delete score
    window.deleteScore = async (id) => {
      if (!confirm('Na pewno usunƒÖƒá tego zawodnika?')) return;

      const { error } = await supabaseClient
        .from("scores")
        .delete()
        .eq("id", id);

      if (error) {
        alert('B≈ÇƒÖd usuwania: ' + error.message);
      } else {
        alert('Usuniƒôto!');
        loadScores(currentChallengeId);
      }
    };

    // Init
    (async function init(){
      updateAdminUI();

      const chs = await loadChallenges();
      if (!chs || chs.length === 0){
        headerSubEl.textContent = "Brak challengy do wy≈õwietlenia.";
        return;
      }

      const currentId = selectEl.value;
      headerSubEl.innerHTML = escapeHtml(selectEl.options[selectEl.selectedIndex]?.textContent || "");
      await loadScores(currentId);

      selectEl.addEventListener("change", async () => {
        headerSubEl.innerHTML = escapeHtml(selectEl.options[selectEl.selectedIndex]?.textContent || "");
        await loadScores(selectEl.value);
      });
    })();
  </script>
</body>
</html>
