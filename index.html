<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASGARD GYM ‚Äî Ranking</title>

  <!-- Font (elegancki, premium) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070a0f;
      --bg1:#0b1220;
      --card:#0c1528cc;
      --stroke:#1c2a44;
      --text:#eaf0ff;
      --muted:#a8b6d8;
      --gold:#d7b46a;
      --gold2:#ffd98a;
      --row:#0b1427;
      --row2:#0a1222;
      --shadow: 0 30px 80px rgba(0,0,0,.55);
      --radius: 20px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 450px at 20% 10%, rgba(215,180,106,.18), transparent 55%),
        radial-gradient(800px 380px at 80% 5%, rgba(120,160,255,.14), transparent 60%),
        radial-gradient(900px 500px at 50% 100%, rgba(0,0,0,.55), transparent 60%),
        linear-gradient(180deg, var(--bg0), #05070c);
      padding: 32px 16px 56px;
      animation: bgPulse 20s ease infinite;
    }

    @keyframes bgPulse {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .wrap{ 
      max-width: 1060px; 
      margin: 0 auto; 
      animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Header */
    .header{
      display:flex; align-items:center; gap:18px;
      margin: 4px 0 22px;
      animation: slideDown 0.8s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo{
      width:80px; 
      height:80px; 
      border-radius:16px;
      display:grid; 
      place-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      transition: transform 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.05) rotate(2deg);
    }

    .logo::after{
      content:"";
      position:absolute; inset:-60%;
      background: radial-gradient(circle at 30% 30%, rgba(215,180,106,.45), transparent 45%),
                  radial-gradient(circle at 70% 70%, rgba(215,180,106,.22), transparent 50%);
      transform: rotate(18deg);
      animation: logoShine 4s ease infinite;
    }

    @keyframes logoShine {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    /* Logo Image (je≈õli bƒôdziesz mia≈Ç plik) */
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      position: relative;
      z-index: 2;
      border-radius: 12px;
    }

    /* Fallback text (jak teraz) */
    .logo span{
      position:relative;
      font-weight:800; 
      letter-spacing:.04em;
      color: var(--gold2);
      text-shadow: 0 2px 18px rgba(215,180,106,.25);
      font-size: 32px;
      z-index: 2;
    }

    .brand h1{
      margin:0;
      font-size: 44px;
      line-height: 1.02;
      letter-spacing: .04em;
      font-weight: 800;
    }
    .brand .sub{
      margin-top:6px;
      color: var(--muted);
      font-size: 16px;
    }
    .brand .sub b{
      color: var(--gold2);
      font-weight: 700;
    }

    /* Card */
    .card{
      background: linear-gradient(180deg, rgba(12,21,40,.92), rgba(9,16,32,.88));
      border: 1px solid rgba(255,255,255,.07);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: cardSlideUp 0.9s ease;
    }

    @keyframes cardSlideUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cardTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 18px 22px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: linear-gradient(90deg, rgba(215,180,106,.09), transparent 60%);
    }
    .cardTop .title{
      font-size: 18px;
      color: var(--muted);
      font-weight: 600;
    }
    select{
      min-width: 360px;
      max-width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      font-weight: 600;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
      transition: all 0.3s ease;
    }
    select:focus{
      border-color: rgba(215,180,106,.45);
      box-shadow: 0 0 0 4px rgba(215,180,106,.10);
      transform: scale(1.02);
    }

    /* Table */
    .tableWrap{ padding: 6px 8px 16px; }
    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.06);
    }
    thead th{
      text-align:left;
      font-size: 16px;
      color: var(--muted);
      padding: 16px 16px;
      background: rgba(0,0,0,.18);
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-weight: 700;
    }
    
    tbody tr {
      animation: rowFadeIn 0.5s ease forwards;
      opacity: 0;
    }

    @keyframes rowFadeIn {
      to { opacity: 1; }
    }

    /* Op√≥≈∫nienie animacji dla kolejnych wierszy */
    tbody tr:nth-child(1) { animation-delay: 0.1s; }
    tbody tr:nth-child(2) { animation-delay: 0.15s; }
    tbody tr:nth-child(3) { animation-delay: 0.2s; }
    tbody tr:nth-child(4) { animation-delay: 0.25s; }
    tbody tr:nth-child(5) { animation-delay: 0.3s; }
    tbody tr:nth-child(6) { animation-delay: 0.35s; }
    tbody tr:nth-child(7) { animation-delay: 0.4s; }
    tbody tr:nth-child(8) { animation-delay: 0.45s; }
    tbody tr:nth-child(9) { animation-delay: 0.5s; }
    tbody tr:nth-child(10) { animation-delay: 0.55s; }

    tbody td{
      padding: 16px 16px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      font-size: 18px;
      transition: all 0.3s ease;
    }
    tbody tr:nth-child(odd) td{ background: rgba(0,0,0,.18); }
    tbody tr:hover td{
      background: rgba(215,180,106,.07);
      transform: translateX(4px);
    }

    .colPlace{ width: 140px; }
    .colWeight{ width: 100px; } /* NOWA kolumna */
    
    .place{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing: .02em;
    }
    .place .num{
      min-width: 22px;
      color: var(--gold2);
      text-shadow: 0 2px 18px rgba(215,180,106,.18);
    }
    .medal{
      font-size: 20px;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.35));
      animation: medalBounce 2s ease infinite;
    }

    @keyframes medalBounce {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-3px); }
    }

    .athlete{
      font-weight: 700;
      font-size: 20px;
    }
    .result{
      display:flex; align-items:baseline; gap:10px;
      justify-content:flex-start;
      font-weight: 800;
      color: var(--gold2);
    }
    .result .unit{
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .02em;
    }

    /* Waga zawodnika */
    .weight {
      color: var(--muted);
      font-size: 16px;
      font-weight: 600;
    }

    .status{
      padding: 10px 22px 18px;
      color: var(--muted);
      font-size: 14px;
      min-height: 22px;
    }
    .err{ color: #ffb4b4; }
    .ok{ color: #bde3c5; }

    /* Mobile */
    @media (max-width: 760px){
      .header{ align-items:flex-start; }
      .brand h1{ font-size: 34px; }
      .cardTop{ flex-direction: column; align-items:flex-start; }
      select{ width:100%; min-width: unset; }
      .colPlace{ width: 110px; }
      .colWeight{ width: 80px; }
      tbody td, thead th{ padding: 14px 12px; }
      .athlete{ font-size: 18px; }
      .logo{ width: 64px; height: 64px; }
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="header">
      <div class="logo" aria-label="Asgard Gym logo">
        <!-- 
          OPCJA A: Je≈õli masz plik logo (np. logo.png):
          <img src="logo.png" alt="Asgard Gym">
          
          OPCJA B: Placeholder tekst (obecny):
        -->
        <span>AG</span>
      </div>
      <div class="brand">
        <h1>ASGARD GYM</h1>
        <div class="sub" id="headerSub">≈Åadowanie challengu‚Ä¶</div>
      </div>
    </div>

    <div class="card">
      <div class="cardTop">
        <div class="title">Wybierz challenge (aktualny + archiwum)</div>
        <select id="challengeSelect" aria-label="Wyb√≥r challengu"></select>
      </div>

      <div class="tableWrap">
        <table id="rankingTable" aria-label="Tabela wynik√≥w">
          <thead>
            <tr>
              <th class="colPlace">Miejsce</th>
              <th>Zawodnik</th>
              <th class="colWeight">Waga</th> <!-- NOWA kolumna -->
              <th>Wynik</th>
            </tr>
          </thead>
          <tbody id="rankingBody"></tbody>
        </table>
      </div>

      <div class="status" id="status"></div>
    </div>

  </div>

  <!-- Supabase JS (tylko raz) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // Supabase config
    const SUPABASE_URL = "https://bzjtdwsvnhukmcjdvyen.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6anRkd3N2bmh1a21jamR2eWVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzc5NDgsImV4cCI6MjA4MTY1Mzk0OH0.o-W4nvYWzvEfxzIX2qJyDEhD21ncMVNBycFzinw7foo";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const selectEl = document.getElementById("challengeSelect");
    const tbodyEl = document.getElementById("rankingBody");
    const headerSubEl = document.getElementById("headerSub");
    const statusEl = document.getElementById("status");

    function medalFor(position){
      if (position === 1) return "ü•á";
      if (position === 2) return "ü•à";
      if (position === 3) return "ü•â";
      return "";
    }

    function setStatus(msg, kind=""){
      statusEl.className = "status " + (kind || "");
      statusEl.textContent = msg || "";
    }

    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    async function loadChallenges(){
      setStatus("≈Åadowanie challengy‚Ä¶");

      const { data, error } = await supabaseClient
        .from("challenges")
        .select("id, title, period, is_active")
        .order("created_at", { ascending: false });

      if (error){
        setStatus("B≈ÇƒÖd pobierania challengy: " + error.message, "err");
        return [];
      }

      const sorted = [...(data || [])].sort((a,b) => (b.is_active?1:0) - (a.is_active?1:0));

      selectEl.innerHTML = "";
      for (const ch of sorted){
        const opt = document.createElement("option");
        const label = `${ch.title} ‚Äî ${ch.period}${ch.is_active ? " (AKTUALNY)" : ""}`;
        opt.value = ch.id;
        opt.textContent = label;
        opt.dataset.isActive = ch.is_active ? "1" : "0";
        selectEl.appendChild(opt);
      }

      const active = sorted.find(x => x.is_active) || sorted[0];
      if (active) selectEl.value = String(active.id);

      setStatus("");
      return sorted;
    }

    async function loadScores(challengeId){
      if (!challengeId) return;

      setStatus("≈Åadowanie wynik√≥w‚Ä¶");
      tbodyEl.innerHTML = "";

      // UWAGA: dodane pole "weight"
      const { data: scores, error } = await supabaseClient
        .from("scores")
        .select("position, athlete, score, unit, weight")
        .eq("challenge_id", Number(challengeId))
        .order("position", { ascending: true })
        .limit(50);

      if (error){
        setStatus("B≈ÇƒÖd pobierania wynik√≥w: " + error.message, "err");
        return;
      }

      const selectedText = selectEl.options[selectEl.selectedIndex]?.textContent || "";
      headerSubEl.innerHTML = escapeHtml(selectedText);

      if (!scores || scores.length === 0){
        setStatus("Brak wynik√≥w dla tego challengu.", "ok");
        return;
      }

      for (const row of scores){
        const pos = Number(row.position);
        const medal = medalFor(pos);
        const weightText = row.weight ? `${row.weight} kg` : "‚Äî";
        
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="colPlace">
            <div class="place">
              <span class="num">${escapeHtml(pos)}</span>
              <span class="medal">${medal}</span>
            </div>
          </td>
          <td><span class="athlete">${escapeHtml(row.athlete)}</span></td>
          <td class="colWeight"><span class="weight">${escapeHtml(weightText)}</span></td>
          <td>
            <div class="result">
              <span>${escapeHtml(row.score)}</span>
              <span class="unit">${escapeHtml(row.unit || "")}</span>
            </div>
          </td>
        `;
        tbodyEl.appendChild(tr);
      }

      setStatus("");
    }

    (async function init(){
      // Minimalny test po≈ÇƒÖczenia
      try {
        const { data, error } = await supabaseClient.from("challenges").select("id").limit(1);
        console.log("Supabase test challenges:", { data, error });
      } catch (e) {
        console.log("Supabase test exception:", e);
      }

      const chs = await loadChallenges();
      if (!chs || chs.length === 0){
        headerSubEl.textContent = "Brak challengy do wy≈õwietlenia.";
        return;
      }

      const currentId = selectEl.value;
      headerSubEl.innerHTML = escapeHtml(selectEl.options[selectEl.selectedIndex]?.textContent || "");
      await loadScores(currentId);

      selectEl.addEventListener("change", async () => {
        headerSubEl.innerHTML = escapeHtml(selectEl.options[selectEl.selectedIndex]?.textContent || "");
        await loadScores(selectEl.value);
      });
    })();
  </script>
</body>
</html>
